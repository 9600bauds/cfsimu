<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">

    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

<script>

var Board = (function() {
    var is_cross_segment = function(ax, ay, bx, by, cx, cy, dx, dy) {
        var ta = (cx - dx) * (ay - cy) + (cy - dy) * (cx - ax);
        var tb = (cx - dx) * (by - cy) + (cy - dy) * (cx - bx);
        var tc = (ax - bx) * (cy - ay) + (ay - by) * (ax - cx);
        var td = (ax - bx) * (dy - ay) + (ay - by) * (ax - dx);

        return tc * td < 0 && ta * tb < 0;
    };
    var is_left = function(ax, ay, bx, by, px, py) {
        var n = px * (ay - by) + ax * (by - py) + bx * (py - ay);
        return n > 0;
    };
    var is_in_triangle = function(portal, cf) {
        return
            is_left(cf.p1.x, cf.p1.y, cf.p2.x, cf.p2.y, portal.x, portal.y) &&
            is_left(cf.p2.x, cf.p2.y, cf.p3.x, cf.p3.y, portal.x, portal.y) &&
            is_left(cf.p3.x, cf.p3.y, cf.p1.x, cf.p1.y, portal.x, portal.y);
    };
    var linkable = function(portal1, portal2) {
        // already linked
        for (var i = 0; i < this.links.length; i++) {
            var link = this.links[i];
            if (link.from.name == portal1.name && link.to.name == portal2.name ||
                link.from.name == portal2.name && link.to.name == portal1.name) {
                return false;
            }
        }
        // portal in a triangle
        for (var i = 0; i < this.cfs.length; i++) {
            var in_triangle = is_in_triangle(portal1);
            if (in_triangle) {
                return false;
            }
        }
        // crossed link
        for (var i = 0; i < this.links.length; i++) {
            var link = this.links[i];
            var cross = is_cross_segment(portal1.x, portal1.y, portal2.x, portal2.y, link.from.x, link.from.y, link.to.x, link.to.y);
            if (cross) {
                return false;
            }
        }
        return true;
    };
    var get_link_portals_from = function(portal) {
        var results = []
        for (var i = 0; i < this.links.length; i++) {
            if (portal.name == this.links[i].from.name) {
                results.push(this.links[i].to);
            } else if (portal.name == this.links[i].to.name) {
                results.push(this.links[i].from);
            }
        }
        return results;
    };
    var intersects_portal = function(portals1, portals2) {
        var intersects = {}
        for (var i = 0; i < set1.length; i++) {
            var name = set1[i].name;
            if (!(name in intersects)) {
                intersects[name] = {
                    portal: set1[i],
                    value: 0,
                }
            }
            intersects[name].value += 1;
        }
        for (var i = 0; i < set2.length; i++) {
            var name = set2[i].name;
            if (!(name in intersects)) {
                intersects[name] = {
                    portal: set2[i],
                    value: 0,
                }
            }
            intersects[name].value += 2;
        }
        var results = [];
        for each (var name in intersects) {
            if (intersects[name].value == 3) {
                results.push(intersects[name].portal);
            }
        }
        return results;
    };

    function Board() {
        this.portals = {};
        this.links = [];
        this.cfs = [];
    }
    Board.prototype.locate_portal = function(name, x, y, color) {
        this.portals[name] = {
            x: x,
            y: y,
            color: color,
        };
    };
    Board.prototype.capture_portal = function(name, color) {
        this.portals[name].color = color;
    };
    Board.prototype.link = function(from, to) {
        var p1 = this.portals[from];
        var p2 = this.portals[to];
        var v = linkable(p1, p2);
        if (!v) {
            return;
        }

        this.links.push({
            from: p1,
            to: p2,
        });
        // create control fields
        from_p1 = get_link_portals_from(p1);
        from_p2 = get_link_portals_from(p2);
        this.cfs
    };
})();

$(function() {
  // locate glyph
  var glyphs = [];
  for (var i = 0; i < GS_GLYPH_POINTS.length; i++) {
    glyphs.push({
      x: GS_BOARD_WIDTH * GS_GLYPH_POINTS[i].x + GS_GLYPH_OFFSET_X,
      y: GS_BOARD_HEIGHT * GS_GLYPH_POINTS[i].y + GS_GLYPH_OFFSET_Y,
    });
  }
  var moving = false;
  var lastHit = null;
  var ctx = $('#canvas')[0].getContext("2d");

  clearCanvas(ctx, $('#canvas'), glyphs);

  var lastMoveX = null;
  var lastMoveY = null;

  var isg = new IncrementalSearchGlyph();
  $('#clear').click(function() {
    isg.clear();
    updateCandidates([]);
  });

  $('#canvas').on('touchstart mousedown', function(e) {
    e.preventDefault();
    moving = true;
    var p = getMousePoint(e, this);

    lastMoveX = p.x;
    lastMoveY = p.y;
  });
  $('#canvas').on('touchmove mousemove', function(e) {
    if (!moving) return;

    e.preventDefault();
    var p = getMousePoint(e, this);
    drawLine(ctx, lastMoveX, lastMoveY, p.x, p.y);
    lastMoveX = p.x;
    lastMoveY = p.y;

    for (var i = 0; i < glyphs.length; i++) {
      if (glyphs[i].x - GS_HIT_SIZE / 2 < p.x && p.x < glyphs[i].x + GS_HIT_SIZE / 2 &&
          glyphs[i].y - GS_HIT_SIZE / 2 < p.y && p.y < glyphs[i].y + GS_HIT_SIZE / 2) {
        if (lastHit == null || lastHit != i) {
          glyphs[i].hit = true;
          lastHit = i;
          drawGlyph(ctx, glyphs, i);

          isg.hitGlyph(i);
          var cd = isg.getCurrentGlyphCandidates();
          updateCandidates(cd);
        }
      }
    }
  });
  $('#canvas').on('touchup mouseup', function(e) {
    if (!moving) return;
    e.preventDefault();
    moving = false;
    isg.nextSequence();
    clearCanvas(ctx, $('#canvas'), glyphs);
  });
  $('#canvas').on('touchcancel mouseleave', function(e) {
    if (!moving) return;
    e.preventDefault();
    moving = false;
    isg.nextSequence();
    clearCanvas(ctx, $('#canvas'), glyphs);
  });
});

</script>

<style type="text/css">
#canvas {
  margin: 20px;
  float: left;
}
</style>

    <title>Ingress Control Field Simulator</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
  </head>
  <body>
    <div id="main" role="main">
      <canvas id="canvas" width="460" height="460"></canvas>
    </div>
    <a id="clear" class="btn btn-default" href="#" role="button">Clear</a>
    <ul id="candidates">
    </ul>
  </body>
</html>
